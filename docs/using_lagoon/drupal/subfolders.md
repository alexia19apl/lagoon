# Drupal in Subfolders

The customizability of Lagoon allows you to run Drupal within a Subfolder of another Application.

An example could be: www.example.com points to one Drupal site, while www.example.com/blog loads a blog built in another Drupal.

It would be possible to run both Drupal's in a single Git Repo and deploy it as a whole, but this workflow might not fit every team and having separate Git repositories fits some situations better.

## Modifications of root application

The root application needs a couple of nginx configs that will configure nginx to be a reverse proxy to the subfolder applications:

#### `location_prepend.conf`

create file `location_prepend.conf`:
```
resolver 8.8.8.8 valid=30s;

location ~ ^/subfolder {
  # if $http_x_forwarded_proto is empty (aka it is not set from an upstream reverseproxy)
  # set it to the current scheme.
  set_if_empty $http_x_forwarded_proto $scheme;

  proxy_set_header      X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header      X-Forwarded-Proto $scheme;
  proxy_set_header      X-Forwarded-Proto $http_x_forwarded_proto;
  proxy_set_header      X-Lagoon-Forwarded-Host $host; # will be used by downstream to know the original host
  proxy_set_header      X-REVERSEPROXY $hostname;
  proxy_set_header      FORWARDED "";  # unset FORWARDED because drupal8 gives errors if it's set
  proxy_set_header      Proxy "";  # unset Proxy because drupal8 gives errors if it's set
  proxy_ssl_server_name on;
  # nginx needs a variable set in order the dns resolution works correctly.
  set                   $subfolder_drupal_host "https://nginx-lagoonproject-${LAGOON_GIT_SAFE_BRANCH}.clustername.com:443"; # LAGOON_GIT_SAFE_BRANCH variable will be replaced during docker entrypoint
  proxy_pass            $subfolder_drupal_host;
  proxy_set_header      Host $proxy_host; # $proxy_host will be automatically generated by nginx based on proxy_pass (it needs to be without scheme and port)
}
```
replace the following strings:
- `/subfolder` with the name of the subfolder you want to use, for example `/blog`
- `nginx` with the service that you want to point too in the subfolder project
- `lagoonproject` with the lagoon projectname of the subfolder project

#### nginx Dockerfile

Add to the nginx Dockerfile (`nginx.dockerfile` or `Dockerfile.nginx`):

```
COPY location_prepend.conf /etc/nginx/conf.d/drupal/location_prepend.conf
RUN fix-permissions /etc/nginx/conf.d/drupal/*
```

## Modifications of subfolder application

Like the root application, we also need to teach the subfolder application that it is running under a subfolder, for this we create two files:

#### `location_drupal_append_subfolder.conf`

create file `location_drupal_append_subfolder.conf`:
```
# With injecting a script name that is prefixed with `subfolder` Drupal will
# render all URLs with `subfolder` prefixed
fastcgi_param  SCRIPT_NAME        /subfolder/index.php;

# If we are running via a reverse proxy, we inject the original HOST url
# into PHP. With this Drupal will render all URLs with the original HOST url
# and not the current used HOST.

# We first set the HOST to the regular host variable.
fastcgi_param  HTTP_HOST          $http_host;
# Then we overwrite it with `X-Lagoon-Forwarded-Host` if it exists.
fastcgi_param  HTTP_HOST          $http_x_lagoon_forwarded_host if_not_empty;
```

replace `/subfolder` with the name of the subfolder, for example `/blog`

#### `server_prepend_subfolder.conf`

create file `server_prepend_subfolder.conf`:
```
# Check for redirects before we do the internal nginx rewrites
# This is done, because the internal nginx rewrites uses `last`
# Which instructs nginx to not check for rewrites anymore (and
# `if` is part of the redirect module)
include /etc/nginx/helpers/010_redirects.conf;

# This is an internal nginx rewrite, it removes `/subfolder/`
# from the requests so that nginx handles the request as it would
# have been `/` from the beginning.
# Important is also the `last` flag, which will cause ngind to not
# execute any more rewrites, because it would cause to redirect forever
# with the rewrites below.
rewrite ^/subfolder/(.*)          /$1             last;

# Make sure redirects are NOT absolute, to make sure nginx does not
# overwrite the host of the URL - which could be another one than nginx
# currently thinks it is serving.
absolute_redirect off;

# If a request just has `/subfolder` we 301 redirect to `/subfolder/`
# (Drupal really likes a trailing slash)
rewrite ^/subfolder               /subfolder/     permanent;

# Any other request we prefix 301 redirect with `/subfolder/`
rewrite ^\/(.*)                   /subfolder/$1   permanent;
```

replace `/subfolder` with the name of the subfolder, for example `/blog`

#### nginx Dockerfile

Add to the nginx Dockerfile (`nginx.dockerfile` or `Dockerfile.nginx`):
```
COPY location_drupal_append_subfolder.conf /etc/nginx/conf.d/drupal/location_drupal_append_subfolder.conf
COPY server_prepend_subfolder.conf /etc/nginx/conf.d/drupal/server_prepend_subfolder.conf
RUN fix-permissions /etc/nginx/conf.d/drupal/*
```

